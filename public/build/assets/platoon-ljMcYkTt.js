var C=C||{};function T(){var e=window.jQuery;if(!e||typeof e.fn.DataTable!="function"){setTimeout(T,50);return}if(document.readyState!=="complete"&&document.readyState!=="interactive"){setTimeout(T,50);return}C={dataTable:null,setup:function(){this.handleMembers(),this.handleSquadMembers(),this.handleForumActivityChart(),this.handleVoiceActivityChart(),this.initAutocomplete(),this.initTagFilter(),this.initBulkTags(),this.initBulkTransfer(),this.initSquadAssignments()},handleForumActivityChart:function(){var t=e(".forum-activity-chart");t.length&&new Chart(t,{type:"doughnut",data:{datasets:[{data:t.data("values"),backgroundColor:t.data("colors"),borderWidth:0}],labels:t.data("labels")},options:{rotation:1*Math.PI,circumference:1*Math.PI,legend:{position:"bottom",labels:{boxWidth:5,fontColor:"#949ba2"},label:{fullWidth:!1}}}})},handleVoiceActivityChart:function(){var t=e(".voice-activity-chart");t.length&&new Chart(t,{type:"doughnut",data:{datasets:[{data:t.data("values"),backgroundColor:t.data("colors"),borderWidth:0}],labels:t.data("labels")},options:{rotation:1*Math.PI,circumference:1*Math.PI,legend:{position:"bottom",labels:{boxWidth:5,fontColor:"#949ba2"},label:{fullWidth:!1}}}})},handleSquadMembers:function(){if(!e(".manage-squads-grid").length)return;var t=e(".mod-plt .sortable");function c(){var a=e(".unassigned-organizer"),n=a.find(".manage-sortable-list"),d=n.find("li").length,u=a.find(".unassigned-organizer-header span");d===0?(a.removeClass("unassigned-organizer").addClass("all-assigned-organizer"),u.html('<i class="fa fa-check-circle text-success"></i> All members assigned to a squad')):(a.removeClass("all-assigned-organizer").addClass("unassigned-organizer"),u.html('<i class="fa fa-exclamation-triangle text-warning"></i> '+d+" "+(d===1?"member":"members")+" not assigned to a squad"))}t.sortable({connectWith:".mod-plt .sortable",placeholder:"ui-sortable-placeholder",forcePlaceholderSize:!0,revert:150,tolerance:"pointer",over:function(a,n){e(this).closest(".manage-squad-card, .unassign-drop-zone").addClass("drag-hover")},out:function(a,n){e(this).closest(".manage-squad-card, .unassign-drop-zone").removeClass("drag-hover")},receive:function(a,n){var d=e(this),u=e(n.sender),s=e(n.item).attr("data-member-id"),m=d.attr("data-squad-id"),o=u.find("li").length,l=d.find("li").length;u.closest(".manage-squad-card").find(".count").text(o),d.closest(".manage-squad-card").find(".count").text(l),c(),m==="0"&&e(n.item).fadeOut(200,function(){e(this).remove()}),e.ajax({type:"POST",url:window.Laravel.appPath+"/members/assign-squad",data:{member_id:s,squad_id:m,_token:e("meta[name=csrf-token]").attr("content")},dataType:"json",success:function(){m==="0"?toastr.success("Member unassigned from platoon"):toastr.success("Member reassigned!")},error:function(){toastr.error("Failed to reassign member")}})},stop:function(a,n){e(".manage-squad-card, .unassign-drop-zone").removeClass("drag-hover")}})},initSquadAssignments:function(){var t=this,c=!1;if(e(".organize-squads-btn").on("click",function(){c=!c;var n=e(this);c?(n.html('<i class="fa fa-check"></i> Done'),n.removeClass("btn-accent").addClass("btn-success"),e(".unassigned-organizer-members").slideDown(200),e(".squad-assignments-section").addClass("organize-mode"),t.enableSquadDragDrop()):(n.html('<i class="fa fa-arrows-alt"></i> Organize'),n.removeClass("btn-success").addClass("btn-accent"),e(".unassigned-organizer-members").slideUp(200),e(".squad-assignments-section").removeClass("organize-mode"))}),e(".squad-drop-target").on("click",function(n){e(".squad-assignments-section").hasClass("organize-mode")&&n.preventDefault()}),new URLSearchParams(window.location.search).get("organize")==="1"){e(".organize-squads-btn").trigger("click");var a=e(".squad-assignments-section");a.length&&e("html, body").animate({scrollTop:a.offset().top-20},400)}},enableSquadDragDrop:function(){e(".unassigned-squad-member").data("ui-draggable")||(e(".unassigned-squad-member").draggable({revert:!0,revertDuration:200,zIndex:1e3,cursor:"grabbing",helper:"clone",appendTo:"body"}),e(".squad-drop-target").droppable({hoverClass:"squad-drop-target--active",drop:function(t,c){var a=e(this),n=c.draggable.attr("data-member-id"),d=a.attr("data-squad-id");e.ajax({type:"POST",url:window.Laravel.appPath+"/members/assign-squad",data:{member_id:n,squad_id:d,_token:e("meta[name=csrf-token]").attr("content")},dataType:"json",success:function(){toastr.success("Member assigned to squad!"),e(c.draggable).fadeOut(200,function(){e(this).remove(),e(".unassigned-squad-member").length<1&&(e(".unassigned-organizer").slideUp(),e(".squad-assignments-section").removeClass("organize-mode"))});var u=a.find(".squad-stat-badge .fa-users").parent(),s=parseInt(u.text().trim())||0;u.html('<i class="fa fa-users"></i> '+(s+1))},error:function(){toastr.error("Failed to assign member to squad")}})}}))},initAutocomplete:function(){e("#leader").bootcomplete({url:window.Laravel.appPath+"/search-member/",minLength:3,idField:!0,method:"POST",dataParams:{_token:e("meta[name=csrf-token]").attr("content")}})},handleMembers:function(){if(!e(".members-table").length)return;var t=this,c=e("table.members-table"),a={};c.find("thead th[data-col]").each(function(r){a[e(this).data("col")]=r}),t.dataTable=c.DataTable({initComplete:function(r,i){setTimeout(function(){e(".ld-loading").removeClass("ld-loading"),t.dataTable.columns.adjust()},2e3)},autoWidth:!1,info:!1,paging:!1,stateSave:!0,order:[[a.member,"asc"]],language:{lengthMenu:""},columnDefs:[{targets:a.checkbox,visible:!1,orderable:!1,searchable:!1},{targets:a.tags,visible:!1},{targets:"no-sort",orderable:!1},{targets:"no-search",searchable:!1},{targets:"col-hidden",visible:!1},{targets:a.rank,orderData:a["rank-id"]},{targets:a["discord-activity"],orderData:a["discord-activity-date"]}],stateSaveParams:function(r,i){i.columns[a.checkbox].visible=!1,i.columns[a.member].visible=!0,i.order&&i.order[0]&&i.order[0][0]===a.checkbox&&(i.order=[[a.member,"asc"]])},stateLoadParams:function(r,i){i.columns[a.checkbox].visible=!1,i.columns[a.member].visible=!0,i.order&&i.order[0]&&i.order[0][0]===a.checkbox&&(i.order=[[a.member,"asc"]])}}),t.cols=a;var n;e(window).on("resize",function(){clearTimeout(n),n=setTimeout(function(){t.dataTable.columns.adjust().draw()},100)});function d(r){return a[r]}function u(r,i){i.visible()?e(r).addClass("active"):e(r).removeClass("active")}e("a.toggle-vis").each(function(){var r=e(this).data("column"),i=d(r);if(i!==void 0){var h=t.dataTable.column(i);u(this,h)}}),e("a.toggle-vis").on("click",function(r){r.preventDefault();var i=e(this).data("column"),h=d(i);if(h!==void 0){var v=t.dataTable.column(h);v.visible(!v.visible()),u(this,v)}});var s=e(".dataTables_filter input").removeClass("input-sm");s.attr({placeholder:"Search Players",class:"form-control"}),e("#playerFilter").append(s),e(".dataTables_filter label").remove();var m=e("#tag-filter");if(m.length){var o=e('<div class="tag-filter-wrapper"></div>');o.append(m),e("#playerFilter").append(o)}var l=e('<button type="button" class="btn btn-default bulk-mode-toggle"><i class="fa fa-check-square-o"></i> Bulk Mode</button>');e("#playerFilter").append(l),e(".no-sort").removeClass("sorting");var b=!1;function f(){b=!b;var r=t.dataTable.column(a.checkbox);r.visible(b),b?(l.addClass("active btn-accent").removeClass("btn-default"),l.html('<i class="fa fa-check-circle"></i> Exit Bulk Mode'),e(".members-table").addClass("bulk-mode")):(l.removeClass("active btn-accent").addClass("btn-default"),l.html('<i class="fa fa-check-square-o"></i> Bulk Mode'),e(".members-table").removeClass("bulk-mode"),e(".member-checkbox, #select-all-members").prop("checked",!1),g())}l.on("click",function(){f()});function g(){var r=[];e(".member-checkbox:checked").each(function(){r.push(e(this).val())});var i=e('.member-checkbox:checked[data-parttimer="1"]').length>0,h=e("#bulk-transfer-btn");i?(h.prop("disabled",!0).addClass("disabled"),h.attr("title","Cannot transfer: selection includes part-time members")):(h.prop("disabled",!1).removeClass("disabled"),h.removeAttr("title")),r.length>=2?(e("#selected-data").css("display","block"),e("#selected-data .status-text").text(r.length+" members selected"),e("#pm-member-data").val(r),e("#tag-member-data").val(r),e("#transfer-member-data").val(r)):(e("#selected-data").hide(),e("#pm-member-data").val(""),e("#tag-member-data").val(""),e("#transfer-member-data").val(""));var v=e(".member-checkbox").length,k=e(".member-checkbox:checked").length;e("#select-all-members").prop("checked",k>0&&k===v),e("#select-all-members").prop("indeterminate",k>0&&k<v)}e(document).on("click",".bulk-action-close",function(){e(".member-checkbox, #select-all-members").prop("checked",!1),g()}),e(document).on("change",".member-checkbox",function(){g()}),e(document).on("change","#select-all-members",function(){var r=e(this).prop("checked");e(".member-checkbox").prop("checked",r),g()});var p=!1,x=!0;e(document).on("mousedown",".members-table.bulk-mode tbody tr",function(r){if(!e(r.target).closest("a, button, input, .btn").length&&r.which===1){p=!0,e(this).index();var i=e(this).find(".member-checkbox");x=!i.prop("checked"),i.prop("checked",x),g(),r.preventDefault()}}),e(document).on("mouseenter",".members-table.bulk-mode tbody tr",function(){if(p){var r=e(this).find(".member-checkbox");r.prop("checked",x),g()}}),e(document).on("mouseup",function(){p=!1}),e("#is_tba").click(function(){q()}),q();function q(){e("#is_tba").is(":checked")?e("#leader_id, #leader").prop("disabled",!0).val(""):e("#leader_id, #leader").prop("disabled",!1)}},initTagFilter:function(){var t=this,c=e("#tag-filter");if(!(!c.length||!t.dataTable||!t.cols)){var a=t.cols["tag-ids"];c.select2({placeholder:"Filter by tag",allowClear:!0}).on("change",function(){t.dataTable.draw()}),e.fn.dataTable.ext.search.push(function(n,d,u){var s=c.val();if(!s||s.length===0)return!0;for(var m=d[a]?d[a].split(","):[],o=0;o<s.length;o++)if(m.indexOf(s[o])!==-1)return!0;return!1})}},initBulkTags:function(){var t=e("#bulk-tags-modal");if(!t.length)return;var c=e("meta[name=csrf-token]").attr("content");function a(){return e("#tag-member-data").val()?e("#tag-member-data").val().split(","):[]}function n(){var s=[];return e(".bulk-tag-checkbox:checked").each(function(){s.push(e(this).val())}),s}function d(){var s=n().length>0;e("#bulk-assign-tags, #bulk-remove-tags").prop("disabled",!s)}t.on("show.bs.modal",function(){var s=a().length;e("#bulk-tags-member-count").text(s+" member"+(s!==1?"s":"")+" selected"),e(".bulk-tag-checkbox").prop("checked",!1).trigger("change")}),e(document).on("change",".bulk-tag-checkbox",function(){var s=e(this).siblings(".bulk-tag-badge");this.checked?s.addClass("selected"):s.removeClass("selected"),d()});function u(s){var m=a(),o=n(),l=t.data("store-url");if(o.length===0){toastr.warning("Please select at least one tag");return}var b=e("#bulk-assign-tags, #bulk-remove-tags");b.prop("disabled",!0),e.ajax({url:l,method:"POST",data:{member_ids:m,tags:o,action:s,_token:c},success:function(){var f=s==="assign"?"Tags assigned to ":"Tags removed from ";toastr.success(f+m.length+" members"),t.modal("hide"),location.reload()},error:function(){toastr.error("Failed to "+s+" tags")},complete:function(){d()}})}e(document).on("click","#bulk-assign-tags",function(){u("assign")}),e(document).on("click","#bulk-remove-tags",function(){u("remove")})},initBulkTransfer:function(){var t=e("#bulk-transfer-modal");if(!t.length)return;var c=e("meta[name=csrf-token]").attr("content"),a=null;function n(){return e("#transfer-member-data").val()?e("#transfer-member-data").val().split(","):[]}function d(){var o=e("#transfer-platoon").val();e("#bulk-transfer-submit").prop("disabled",!o)}function u(){if(a){s();return}var o=t.data("platoons-url");e.ajax({url:o,method:"GET",success:function(l){a=l.platoons,s()},error:function(){toastr.error("Failed to load platoons")}})}function s(){var o=e("#transfer-platoon");o.find("option:not(:first)").remove(),a.forEach(function(l){o.append(e("<option>",{value:l.id,text:l.name}))})}function m(o){var l=e("#transfer-squad");if(l.find("option:not(:first)").remove(),!o){l.prop("disabled",!0);return}var b=a.find(function(f){return f.id==o});b&&b.squads.length>0?(b.squads.forEach(function(f){l.append(e("<option>",{value:f.id,text:f.name}))}),l.prop("disabled",!1)):l.prop("disabled",!0)}t.on("show.bs.modal",function(){var o=t.data("parttimers")==="true";if(o){e("#bulk-transfer-parttimer-warning").show(),e("#bulk-transfer-form-content").hide(),e("#bulk-transfer-submit").hide();return}e("#bulk-transfer-parttimer-warning").hide(),e("#bulk-transfer-form-content").show(),e("#bulk-transfer-submit").show();var l=n().length;e("#bulk-transfer-member-count").text(l+" member"+(l!==1?"s":"")+" selected"),e("#transfer-platoon").val(""),e("#transfer-squad").val("").prop("disabled",!0),d(),u()}),e(document).on("change","#transfer-platoon",function(){var o=e(this).val();m(o),d()}),e(document).on("click","#bulk-transfer-submit",function(){var o=n(),l=e("#transfer-platoon").val(),b=e("#transfer-squad").val(),f=t.data("store-url");if(!l){toastr.warning("Please select a platoon");return}var g=e(this);g.prop("disabled",!0).html('<span class="themed-spinner spinner-sm"></span> Transferring...'),e.ajax({url:f,method:"POST",data:{member_ids:o,platoon_id:l,squad_id:b||null,_token:c},success:function(p){toastr.success(p.message),t.modal("hide"),location.reload()},error:function(){toastr.error("Failed to transfer members")},complete:function(){g.prop("disabled",!1).html('<i class="fa fa-exchange-alt"></i> Transfer'),d()}})})}},C.setup()}T();
