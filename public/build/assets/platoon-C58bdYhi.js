var w=w||{};function q(){var e=window.jQuery;if(!e||typeof e.fn.DataTable!="function"||typeof e.fn.bootcomplete!="function"||typeof e.fn.select2!="function"){setTimeout(q,50);return}if(document.readyState!=="complete"&&document.readyState!=="interactive"){setTimeout(q,50);return}w={dataTable:null,setup:function(){this.handleMembers(),this.handleSquadMembers(),this.handleVoiceActivityChart(),this.initAutocomplete(),this.initTagFilter(),this.initBulkTags(),this.initBulkTransfer(),this.initSquadAssignments(),this.initBulkReminder()},handleVoiceActivityChart:function(){var t=document.getElementById("voice-activity-chart");if(!(!t||typeof Chart>"u")){var u=JSON.parse(t.dataset.values||"[]"),a=JSON.parse(t.dataset.labels||"[]"),o=JSON.parse(t.dataset.colors||"[]");if(!(!u||!a||u.length===0)){var d=getComputedStyle(document.documentElement),l=d.getPropertyValue("--color-text-light").trim()||"#949ba2",r=d.getPropertyValue("--color-bg-panel").trim()||"#1a1d21",m=u.reduce(function(s,c){return s+c},0);new Chart(t,{type:"doughnut",data:{labels:a,datasets:[{data:u,backgroundColor:o,borderColor:r,borderWidth:1,hoverBorderColor:r,hoverOffset:2}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"60%",plugins:{legend:{display:!0,position:"bottom",labels:{color:l,usePointStyle:!0,pointStyle:"circle",font:{size:11},padding:12,boxWidth:8,boxHeight:8}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.7)",titleFont:{size:12},bodyFont:{size:11},padding:10,cornerRadius:6,callbacks:{label:function(s){var c=m>0?Math.round(s.parsed/m*100):0;return s.label+": "+s.parsed+" ("+c+"%)"}}}}}})}}},handleSquadMembers:function(){if(!e(".manage-squads-grid").length)return;var t=e(".mod-plt .sortable");function u(){var a=e(".unassigned-organizer"),o=a.find(".manage-sortable-list"),d=o.find("li").length,l=a.find(".unassigned-organizer-header span");d===0?(a.removeClass("unassigned-organizer").addClass("all-assigned-organizer"),l.html('<i class="fa fa-check-circle text-success"></i> All members assigned to a squad')):(a.removeClass("all-assigned-organizer").addClass("unassigned-organizer"),l.html('<i class="fa fa-exclamation-triangle text-warning"></i> '+d+" "+(d===1?"member":"members")+" not assigned to a squad"))}t.sortable({connectWith:".mod-plt .sortable",placeholder:"ui-sortable-placeholder",forcePlaceholderSize:!0,revert:150,tolerance:"pointer",over:function(a,o){e(this).closest(".manage-squad-card, .unassign-drop-zone").addClass("drag-hover")},out:function(a,o){e(this).closest(".manage-squad-card, .unassign-drop-zone").removeClass("drag-hover")},receive:function(a,o){var d=e(this),l=e(o.sender),r=e(o.item).attr("data-member-id"),m=d.attr("data-squad-id"),s=l.find("li").length,c=d.find("li").length;l.closest(".manage-squad-card").find(".count").text(s),d.closest(".manage-squad-card").find(".count").text(c),u(),m==="0"&&e(o.item).fadeOut(200,function(){e(this).remove()}),e.ajax({type:"POST",url:window.Laravel.appPath+"/members/assign-squad",data:{member_id:r,squad_id:m,_token:e("meta[name=csrf-token]").attr("content")},dataType:"json",success:function(){m==="0"?toastr.success("Member unassigned from platoon"):toastr.success("Member reassigned!")},error:function(){toastr.error("Failed to reassign member")}})},stop:function(a,o){e(".manage-squad-card, .unassign-drop-zone").removeClass("drag-hover")}})},initSquadAssignments:function(){var t=this,u=!1;if(e(".organize-squads-btn").on("click",function(){u=!u;var o=e(this);u?(o.html('<i class="fa fa-check"></i> Done'),o.removeClass("btn-accent").addClass("btn-success"),e(".unassigned-organizer-members").slideDown(200),e(".squad-assignments-section").addClass("organize-mode"),t.enableSquadDragDrop()):(o.html('<i class="fa fa-arrows-alt"></i> Organize'),o.removeClass("btn-success").addClass("btn-accent"),e(".unassigned-organizer-members").slideUp(200),e(".squad-assignments-section").removeClass("organize-mode"))}),e(".squad-drop-target").on("click",function(o){e(".squad-assignments-section").hasClass("organize-mode")&&o.preventDefault()}),new URLSearchParams(window.location.search).get("organize")==="1"){e(".organize-squads-btn").trigger("click");var a=e(".squad-assignments-section");a.length&&e("html, body").animate({scrollTop:a.offset().top-20},400)}},enableSquadDragDrop:function(){e(".unassigned-squad-member").data("ui-draggable")||(e(".unassigned-squad-member").draggable({revert:!0,revertDuration:200,zIndex:1e3,cursor:"grabbing",helper:"clone",appendTo:"body"}),e(".squad-drop-target").droppable({hoverClass:"squad-drop-target--active",drop:function(t,u){var a=e(this),o=u.draggable.attr("data-member-id"),d=a.attr("data-squad-id");e.ajax({type:"POST",url:window.Laravel.appPath+"/members/assign-squad",data:{member_id:o,squad_id:d,_token:e("meta[name=csrf-token]").attr("content")},dataType:"json",success:function(){toastr.success("Member assigned to squad!"),e(u.draggable).fadeOut(200,function(){e(this).remove(),e(".unassigned-squad-member").length<1&&(e(".unassigned-organizer").slideUp(),e(".squad-assignments-section").removeClass("organize-mode"))});var l=a.find(".squad-stat-badge .fa-users").parent(),r=parseInt(l.text().trim())||0;l.html('<i class="fa fa-users"></i> '+(r+1))},error:function(){toastr.error("Failed to assign member to squad")}})}}))},initAutocomplete:function(){e("#leader").bootcomplete({url:window.Laravel.appPath+"/search-member/",minLength:3,idField:!0,method:"POST",dataParams:{_token:e("meta[name=csrf-token]").attr("content")}})},handleMembers:function(){if(!e(".members-table").length)return;var t=this,u=e("table.members-table"),a={};u.find("thead th[data-col]").each(function(n){a[e(this).data("col")]=n}),t.dataTable=u.DataTable({initComplete:function(n,i){setTimeout(function(){e(".ld-loading").removeClass("ld-loading"),t.dataTable.columns.adjust()},2e3)},autoWidth:!1,info:!1,paging:!1,stateSave:!0,order:[[a.member,"asc"]],language:{lengthMenu:""},columnDefs:[{targets:a.checkbox,visible:!1,orderable:!1,searchable:!1},{targets:a.tags,visible:!1},{targets:a["inactivity-reminder"],visible:!1},{targets:"no-sort",orderable:!1},{targets:"no-search",searchable:!1},{targets:"col-hidden",visible:!1},{targets:a.rank,orderData:a["rank-id"]},{targets:a["discord-activity"],orderData:a["discord-activity-date"]},{targets:a["inactivity-reminder"],orderData:a["reminder-date"]}],stateSaveParams:function(n,i){i.columns[a.checkbox].visible=!1,i.columns[a.member].visible=!0,i.order&&i.order[0]&&i.order[0][0]===a.checkbox&&(i.order=[[a.member,"asc"]])},stateLoadParams:function(n,i){i.columns[a.checkbox].visible=!1,i.columns[a.member].visible=!0,i.order&&i.order[0]&&i.order[0][0]===a.checkbox&&(i.order=[[a.member,"asc"]])}}),t.cols=a;var o;e(window).on("resize",function(){clearTimeout(o),o=setTimeout(function(){t.dataTable.columns.adjust().draw()},100)});function d(n){return a[n]}function l(n,i){var f=e(n),h=f.find("i.fa");i.visible()?(f.addClass("active"),h.removeClass("fa-square-o").addClass("fa-check")):(f.removeClass("active"),h.removeClass("fa-check").addClass("fa-square-o"))}e("a.toggle-vis").each(function(){var n=e(this).data("column"),i=d(n);if(i!==void 0){var f=t.dataTable.column(i);l(this,f)}}),e("a.toggle-vis").on("click",function(n){n.preventDefault(),n.stopPropagation();var i=e(this).data("column"),f=d(i);if(f!==void 0){var h=t.dataTable.column(f);h.visible(!h.visible()),l(this,h)}});var r=e(".column-dropdown"),m=r.find(".dropdown-toggle"),s=r.find(".column-toggle-menu");m.on("click",function(n){n.preventDefault(),n.stopPropagation();var i=r.hasClass("show");i?(r.removeClass("show"),s.removeClass("show")):(r.addClass("show"),s.addClass("show"),s.scrollTop(0))}),e(document).on("click",function(n){e(n.target).closest(".column-dropdown").length||(r.removeClass("show"),s.removeClass("show"))});var c=e(".dataTables_filter input").removeClass("input-sm");c.attr({placeholder:"Search Players",class:"form-control"}),e("#playerFilter").append(c),e(".dataTables_filter label").remove();var v=e("#tag-filter");if(v.length){var b=e('<div class="tag-filter-wrapper"></div>');b.append(v),e("#playerFilter").append(b)}var g=null,p=!1;window.Laravel&&window.Laravel.canUseBulkMode&&(g=e('<button type="button" class="btn btn-default bulk-mode-toggle">Bulk Mode</button>'),e("#playerFilter").append(g),g.on("click",function(){S()})),e(".no-sort").removeClass("sorting");function S(){if(g){p=!p;var n=t.dataTable.column(a.checkbox);n.visible(p),p?(g.addClass("active btn-accent").removeClass("btn-default"),g.html('<i class="fa fa-check-circle"></i> Exit Bulk Mode'),e(".members-table").addClass("bulk-mode")):(g.removeClass("active btn-accent").addClass("btn-default"),g.html("Bulk Mode"),e(".members-table").removeClass("bulk-mode"),e(".member-checkbox, #select-all-members").prop("checked",!1),k())}}function k(){var n=[];e(".member-checkbox:checked").each(function(){n.push(e(this).val())});var i=e('.member-checkbox:checked[data-parttimer="1"]').length>0,f=e("#bulk-transfer-btn");i?(f.prop("disabled",!0).addClass("disabled"),f.attr("title","Cannot transfer: selection includes part-time members")):(f.prop("disabled",!1).removeClass("disabled"),f.removeAttr("title")),n.length>=1?(e("#selected-data").css("display","block"),e("#selected-data .status-text").text(n.length+" member"+(n.length===1?"":"s")+" selected"),e("#pm-member-data").val(n),e("#tag-member-data").val(n),e("#transfer-member-data").val(n)):(e("#selected-data").hide(),e("#pm-member-data").val(""),e("#tag-member-data").val(""),e("#transfer-member-data").val(""));var h=e(".member-checkbox").length,C=e(".member-checkbox:checked").length;e("#select-all-members").prop("checked",C>0&&C===h),e("#select-all-members").prop("indeterminate",C>0&&C<h)}e(document).on("click",".bulk-action-close",function(){e(".member-checkbox, #select-all-members").prop("checked",!1),k()}),e(document).on("change",".member-checkbox",function(){k()}),e(document).on("change","#select-all-members",function(){var n=e(this).prop("checked");e(".member-checkbox").prop("checked",n),k()});var x=!1,T=!0;e(document).on("mousedown",".members-table.bulk-mode tbody tr",function(n){if(!e(n.target).closest("a, button, input, .btn").length&&n.which===1){x=!0,e(this).index();var i=e(this).find(".member-checkbox");T=!i.prop("checked"),i.prop("checked",T),k(),n.preventDefault()}}),e(document).on("mouseenter",".members-table.bulk-mode tbody tr",function(){if(x){var n=e(this).find(".member-checkbox");n.prop("checked",T),k()}}),e(document).on("mouseup",function(){x=!1}),e("#is_tba").click(function(){y()}),y();function y(){e("#is_tba").is(":checked")?e("#leader_id, #leader").prop("disabled",!0).val(""):e("#leader_id, #leader").prop("disabled",!1)}},initTagFilter:function(){var t=this,u=e("#tag-filter");if(!(!u.length||!t.dataTable||!t.cols)){var a=t.cols["tag-ids"];u.select2({placeholder:"Filter by tag",allowClear:!0}).on("change",function(){t.dataTable.draw()}),e.fn.dataTable.ext.search.push(function(o,d,l){var r=u.val();if(!r||r.length===0)return!0;for(var m=d[a]?d[a].split(","):[],s=0;s<r.length;s++)if(m.indexOf(r[s])!==-1)return!0;return!1})}},initBulkTags:function(){var t=e("#bulk-tags-modal");if(!t.length)return;var u=e("meta[name=csrf-token]").attr("content");function a(){return e("#tag-member-data").val()?e("#tag-member-data").val().split(","):[]}function o(){var r=[];return e(".bulk-tag-checkbox:checked").each(function(){r.push(e(this).val())}),r}function d(){var r=o().length>0;e("#bulk-assign-tags, #bulk-remove-tags").prop("disabled",!r)}t.on("show.bs.modal",function(){var r=a().length;e("#bulk-tags-member-count").text(r+" member"+(r!==1?"s":"")+" selected"),e(".bulk-tag-checkbox").prop("checked",!1).trigger("change")}),e(document).on("change",".bulk-tag-checkbox",function(){var r=e(this).siblings(".bulk-tag-badge");this.checked?r.addClass("selected"):r.removeClass("selected"),d()});function l(r){var m=a(),s=o(),c=t.data("store-url");if(s.length===0){toastr.warning("Please select at least one tag");return}var v=e("#bulk-assign-tags, #bulk-remove-tags");v.prop("disabled",!0),e.ajax({url:c,method:"POST",data:{member_ids:m,tags:s,action:r,_token:u},success:function(){var b=r==="assign"?"Tags assigned to ":"Tags removed from ";toastr.success(b+m.length+" members"),t.modal("hide"),location.reload()},error:function(){toastr.error("Failed to "+r+" tags")},complete:function(){d()}})}e(document).on("click","#bulk-assign-tags",function(){l("assign")}),e(document).on("click","#bulk-remove-tags",function(){l("remove")})},initBulkTransfer:function(){var t=e("#bulk-transfer-modal");if(!t.length)return;var u=e("meta[name=csrf-token]").attr("content"),a=null;function o(){return e("#transfer-member-data").val()?e("#transfer-member-data").val().split(","):[]}function d(){var s=e("#transfer-platoon").val();e("#bulk-transfer-submit").prop("disabled",!s)}function l(){if(a){r();return}var s=t.data("platoons-url");e.ajax({url:s,method:"GET",success:function(c){a=c.platoons,r()},error:function(){toastr.error("Failed to load platoons")}})}function r(){var s=e("#transfer-platoon");s.find("option:not(:first)").remove(),a.forEach(function(c){s.append(e("<option>",{value:c.id,text:c.name}))})}function m(s){var c=e("#transfer-squad");if(c.find("option:not(:first)").remove(),!s){c.prop("disabled",!0);return}var v=a.find(function(b){return b.id==s});v&&v.squads.length>0?(v.squads.forEach(function(b){c.append(e("<option>",{value:b.id,text:b.name}))}),c.prop("disabled",!1)):c.prop("disabled",!0)}t.on("show.bs.modal",function(){var s=t.data("parttimers")==="true";if(s){e("#bulk-transfer-parttimer-warning").show(),e("#bulk-transfer-form-content").hide(),e("#bulk-transfer-submit").hide();return}e("#bulk-transfer-parttimer-warning").hide(),e("#bulk-transfer-form-content").show(),e("#bulk-transfer-submit").show();var c=o().length;e("#bulk-transfer-member-count").text(c+" member"+(c!==1?"s":"")+" selected"),e("#transfer-platoon").val(""),e("#transfer-squad").val("").prop("disabled",!0),d(),l()}),e(document).on("change","#transfer-platoon",function(){var s=e(this).val();m(s),d()}),e(document).on("click","#bulk-transfer-submit",function(){var s=o(),c=e("#transfer-platoon").val(),v=e("#transfer-squad").val(),b=t.data("store-url");if(!c){toastr.warning("Please select a platoon");return}var g=e(this);g.prop("disabled",!0).html('<span class="themed-spinner spinner-sm"></span> Transferring...'),e.ajax({url:b,method:"POST",data:{member_ids:s,platoon_id:c,squad_id:v||null,_token:u},success:function(p){toastr.success(p.message),t.modal("hide"),location.reload()},error:function(){toastr.error("Failed to transfer members")},complete:function(){g.prop("disabled",!1).html('<i class="fa fa-exchange-alt"></i> Transfer'),d()}})})},initBulkReminder:function(){var t=e("#bulk-reminder-btn");if(t.length){var u=e("meta[name=csrf-token]").attr("content");t.on("click",function(){var a=e("#pm-member-data").val();if(!a){toastr.warning("No members selected");return}var o=a.split(","),d=t.data("url");t.prop("disabled",!0).html('<span class="themed-spinner spinner-sm"></span>'),e.ajax({url:d,method:"POST",data:{_token:u,member_ids:o},success:function(l){var r=l.count+" member"+(l.count!==1?"s":"")+" marked as reminded";l.skipped>0&&(r+=" ("+l.skipped+" skipped - already reminded today)"),toastr.success(r),l.updatedIds.forEach(function(m){var s=e('.activity-reminder-toggle[data-member-id="'+m+'"]');s.length&&(s.removeClass("btn-success").addClass("btn-default"),s.html('<i class="fa fa-bell"></i> <span class="reminded-date">'+l.date+"</span>"),s.attr("title","Reminded just now"),s.prop("disabled",!0))}),e(".bulk-action-close").click()},error:function(l){var r=l.responseJSON?.message||"Failed to set reminders";toastr.error(r)},complete:function(){t.prop("disabled",!1).html('<i class="fa fa-bell text-accent"></i> <span class="hidden-xs hidden-sm">Reminder</span>')}})})}}},w.setup()}q();
