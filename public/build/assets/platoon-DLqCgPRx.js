var x=x||{};function T(){var e=window.jQuery;if(!e||typeof e.fn.DataTable!="function"){setTimeout(T,50);return}if(document.readyState!=="complete"&&document.readyState!=="interactive"){setTimeout(T,50);return}x={dataTable:null,setup:function(){this.handleMembers(),this.handleSquadMembers(),this.handleForumActivityChart(),this.handleVoiceActivityChart(),this.initAutocomplete(),this.initTagFilter(),this.initBulkTags(),this.initBulkTransfer(),this.initSquadAssignments(),this.initBulkReminder()},handleForumActivityChart:function(){var t=e(".forum-activity-chart");t.length&&new Chart(t,{type:"doughnut",data:{datasets:[{data:t.data("values"),backgroundColor:t.data("colors"),borderWidth:0}],labels:t.data("labels")},options:{rotation:1*Math.PI,circumference:1*Math.PI,legend:{position:"bottom",labels:{boxWidth:5,fontColor:"#949ba2"},label:{fullWidth:!1}}}})},handleVoiceActivityChart:function(){var t=e(".voice-activity-chart");t.length&&new Chart(t,{type:"doughnut",data:{datasets:[{data:t.data("values"),backgroundColor:t.data("colors"),borderWidth:0}],labels:t.data("labels")},options:{rotation:1*Math.PI,circumference:1*Math.PI,legend:{position:"bottom",labels:{boxWidth:5,fontColor:"#949ba2"},label:{fullWidth:!1}}}})},handleSquadMembers:function(){if(!e(".manage-squads-grid").length)return;var t=e(".mod-plt .sortable");function u(){var a=e(".unassigned-organizer"),o=a.find(".manage-sortable-list"),c=o.find("li").length,l=a.find(".unassigned-organizer-header span");c===0?(a.removeClass("unassigned-organizer").addClass("all-assigned-organizer"),l.html('<i class="fa fa-check-circle text-success"></i> All members assigned to a squad')):(a.removeClass("all-assigned-organizer").addClass("unassigned-organizer"),l.html('<i class="fa fa-exclamation-triangle text-warning"></i> '+c+" "+(c===1?"member":"members")+" not assigned to a squad"))}t.sortable({connectWith:".mod-plt .sortable",placeholder:"ui-sortable-placeholder",forcePlaceholderSize:!0,revert:150,tolerance:"pointer",over:function(a,o){e(this).closest(".manage-squad-card, .unassign-drop-zone").addClass("drag-hover")},out:function(a,o){e(this).closest(".manage-squad-card, .unassign-drop-zone").removeClass("drag-hover")},receive:function(a,o){var c=e(this),l=e(o.sender),r=e(o.item).attr("data-member-id"),m=c.attr("data-squad-id"),s=l.find("li").length,i=c.find("li").length;l.closest(".manage-squad-card").find(".count").text(s),c.closest(".manage-squad-card").find(".count").text(i),u(),m==="0"&&e(o.item).fadeOut(200,function(){e(this).remove()}),e.ajax({type:"POST",url:window.Laravel.appPath+"/members/assign-squad",data:{member_id:r,squad_id:m,_token:e("meta[name=csrf-token]").attr("content")},dataType:"json",success:function(){m==="0"?toastr.success("Member unassigned from platoon"):toastr.success("Member reassigned!")},error:function(){toastr.error("Failed to reassign member")}})},stop:function(a,o){e(".manage-squad-card, .unassign-drop-zone").removeClass("drag-hover")}})},initSquadAssignments:function(){var t=this,u=!1;if(e(".organize-squads-btn").on("click",function(){u=!u;var o=e(this);u?(o.html('<i class="fa fa-check"></i> Done'),o.removeClass("btn-accent").addClass("btn-success"),e(".unassigned-organizer-members").slideDown(200),e(".squad-assignments-section").addClass("organize-mode"),t.enableSquadDragDrop()):(o.html('<i class="fa fa-arrows-alt"></i> Organize'),o.removeClass("btn-success").addClass("btn-accent"),e(".unassigned-organizer-members").slideUp(200),e(".squad-assignments-section").removeClass("organize-mode"))}),e(".squad-drop-target").on("click",function(o){e(".squad-assignments-section").hasClass("organize-mode")&&o.preventDefault()}),new URLSearchParams(window.location.search).get("organize")==="1"){e(".organize-squads-btn").trigger("click");var a=e(".squad-assignments-section");a.length&&e("html, body").animate({scrollTop:a.offset().top-20},400)}},enableSquadDragDrop:function(){e(".unassigned-squad-member").data("ui-draggable")||(e(".unassigned-squad-member").draggable({revert:!0,revertDuration:200,zIndex:1e3,cursor:"grabbing",helper:"clone",appendTo:"body"}),e(".squad-drop-target").droppable({hoverClass:"squad-drop-target--active",drop:function(t,u){var a=e(this),o=u.draggable.attr("data-member-id"),c=a.attr("data-squad-id");e.ajax({type:"POST",url:window.Laravel.appPath+"/members/assign-squad",data:{member_id:o,squad_id:c,_token:e("meta[name=csrf-token]").attr("content")},dataType:"json",success:function(){toastr.success("Member assigned to squad!"),e(u.draggable).fadeOut(200,function(){e(this).remove(),e(".unassigned-squad-member").length<1&&(e(".unassigned-organizer").slideUp(),e(".squad-assignments-section").removeClass("organize-mode"))});var l=a.find(".squad-stat-badge .fa-users").parent(),r=parseInt(l.text().trim())||0;l.html('<i class="fa fa-users"></i> '+(r+1))},error:function(){toastr.error("Failed to assign member to squad")}})}}))},initAutocomplete:function(){e("#leader").bootcomplete({url:window.Laravel.appPath+"/search-member/",minLength:3,idField:!0,method:"POST",dataParams:{_token:e("meta[name=csrf-token]").attr("content")}})},handleMembers:function(){if(!e(".members-table").length)return;var t=this,u=e("table.members-table"),a={};u.find("thead th[data-col]").each(function(n){a[e(this).data("col")]=n}),t.dataTable=u.DataTable({initComplete:function(n,d){setTimeout(function(){e(".ld-loading").removeClass("ld-loading"),t.dataTable.columns.adjust()},2e3)},autoWidth:!1,info:!1,paging:!1,stateSave:!0,order:[[a.member,"asc"]],language:{lengthMenu:""},columnDefs:[{targets:a.checkbox,visible:!1,orderable:!1,searchable:!1},{targets:a.tags,visible:!1},{targets:a["inactivity-reminder"],visible:!1},{targets:"no-sort",orderable:!1},{targets:"no-search",searchable:!1},{targets:"col-hidden",visible:!1},{targets:a.rank,orderData:a["rank-id"]},{targets:a["discord-activity"],orderData:a["discord-activity-date"]},{targets:a["inactivity-reminder"],orderData:a["reminder-date"]}],stateSaveParams:function(n,d){d.columns[a.checkbox].visible=!1,d.columns[a.member].visible=!0,d.order&&d.order[0]&&d.order[0][0]===a.checkbox&&(d.order=[[a.member,"asc"]])},stateLoadParams:function(n,d){d.columns[a.checkbox].visible=!1,d.columns[a.member].visible=!0,d.order&&d.order[0]&&d.order[0][0]===a.checkbox&&(d.order=[[a.member,"asc"]])}}),t.cols=a;var o;e(window).on("resize",function(){clearTimeout(o),o=setTimeout(function(){t.dataTable.columns.adjust().draw()},100)});function c(n){return a[n]}function l(n,d){var f=e(n),v=f.find("i.fa");d.visible()?(f.addClass("active"),v.removeClass("fa-square-o").addClass("fa-check")):(f.removeClass("active"),v.removeClass("fa-check").addClass("fa-square-o"))}e("a.toggle-vis").each(function(){var n=e(this).data("column"),d=c(n);if(d!==void 0){var f=t.dataTable.column(d);l(this,f)}}),e("a.toggle-vis").on("click",function(n){n.preventDefault(),n.stopPropagation();var d=e(this).data("column"),f=c(d);if(f!==void 0){var v=t.dataTable.column(f);v.visible(!v.visible()),l(this,v)}});var r=e(".dataTables_filter input").removeClass("input-sm");r.attr({placeholder:"Search Players",class:"form-control"}),e("#playerFilter").append(r),e(".dataTables_filter label").remove();var m=e("#tag-filter");if(m.length){var s=e('<div class="tag-filter-wrapper"></div>');s.append(m),e("#playerFilter").append(s)}var i=e('<button type="button" class="btn btn-default bulk-mode-toggle"><i class="fa fa-check-square-o"></i> Bulk Mode</button>');e("#playerFilter").append(i),e(".no-sort").removeClass("sorting");var b=!1;function g(){b=!b;var n=t.dataTable.column(a.checkbox);n.visible(b),b?(i.addClass("active btn-accent").removeClass("btn-default"),i.html('<i class="fa fa-check-circle"></i> Exit Bulk Mode'),e(".members-table").addClass("bulk-mode")):(i.removeClass("active btn-accent").addClass("btn-default"),i.html('<i class="fa fa-check-square-o"></i> Bulk Mode'),e(".members-table").removeClass("bulk-mode"),e(".member-checkbox, #select-all-members").prop("checked",!1),h())}i.on("click",function(){g()});function h(){var n=[];e(".member-checkbox:checked").each(function(){n.push(e(this).val())});var d=e('.member-checkbox:checked[data-parttimer="1"]').length>0,f=e("#bulk-transfer-btn");d?(f.prop("disabled",!0).addClass("disabled"),f.attr("title","Cannot transfer: selection includes part-time members")):(f.prop("disabled",!1).removeClass("disabled"),f.removeAttr("title")),n.length>=2?(e("#selected-data").css("display","block"),e("#selected-data .status-text").text(n.length+" members selected"),e("#pm-member-data").val(n),e("#tag-member-data").val(n),e("#transfer-member-data").val(n)):(e("#selected-data").hide(),e("#pm-member-data").val(""),e("#tag-member-data").val(""),e("#transfer-member-data").val(""));var v=e(".member-checkbox").length,k=e(".member-checkbox:checked").length;e("#select-all-members").prop("checked",k>0&&k===v),e("#select-all-members").prop("indeterminate",k>0&&k<v)}e(document).on("click",".bulk-action-close",function(){e(".member-checkbox, #select-all-members").prop("checked",!1),h()}),e(document).on("change",".member-checkbox",function(){h()}),e(document).on("change","#select-all-members",function(){var n=e(this).prop("checked");e(".member-checkbox").prop("checked",n),h()});var p=!1,C=!0;e(document).on("mousedown",".members-table.bulk-mode tbody tr",function(n){if(!e(n.target).closest("a, button, input, .btn").length&&n.which===1){p=!0,e(this).index();var d=e(this).find(".member-checkbox");C=!d.prop("checked"),d.prop("checked",C),h(),n.preventDefault()}}),e(document).on("mouseenter",".members-table.bulk-mode tbody tr",function(){if(p){var n=e(this).find(".member-checkbox");n.prop("checked",C),h()}}),e(document).on("mouseup",function(){p=!1}),e("#is_tba").click(function(){q()}),q();function q(){e("#is_tba").is(":checked")?e("#leader_id, #leader").prop("disabled",!0).val(""):e("#leader_id, #leader").prop("disabled",!1)}},initTagFilter:function(){var t=this,u=e("#tag-filter");if(!(!u.length||!t.dataTable||!t.cols)){var a=t.cols["tag-ids"];u.select2({placeholder:"Filter by tag",allowClear:!0}).on("change",function(){t.dataTable.draw()}),e.fn.dataTable.ext.search.push(function(o,c,l){var r=u.val();if(!r||r.length===0)return!0;for(var m=c[a]?c[a].split(","):[],s=0;s<r.length;s++)if(m.indexOf(r[s])!==-1)return!0;return!1})}},initBulkTags:function(){var t=e("#bulk-tags-modal");if(!t.length)return;var u=e("meta[name=csrf-token]").attr("content");function a(){return e("#tag-member-data").val()?e("#tag-member-data").val().split(","):[]}function o(){var r=[];return e(".bulk-tag-checkbox:checked").each(function(){r.push(e(this).val())}),r}function c(){var r=o().length>0;e("#bulk-assign-tags, #bulk-remove-tags").prop("disabled",!r)}t.on("show.bs.modal",function(){var r=a().length;e("#bulk-tags-member-count").text(r+" member"+(r!==1?"s":"")+" selected"),e(".bulk-tag-checkbox").prop("checked",!1).trigger("change")}),e(document).on("change",".bulk-tag-checkbox",function(){var r=e(this).siblings(".bulk-tag-badge");this.checked?r.addClass("selected"):r.removeClass("selected"),c()});function l(r){var m=a(),s=o(),i=t.data("store-url");if(s.length===0){toastr.warning("Please select at least one tag");return}var b=e("#bulk-assign-tags, #bulk-remove-tags");b.prop("disabled",!0),e.ajax({url:i,method:"POST",data:{member_ids:m,tags:s,action:r,_token:u},success:function(){var g=r==="assign"?"Tags assigned to ":"Tags removed from ";toastr.success(g+m.length+" members"),t.modal("hide"),location.reload()},error:function(){toastr.error("Failed to "+r+" tags")},complete:function(){c()}})}e(document).on("click","#bulk-assign-tags",function(){l("assign")}),e(document).on("click","#bulk-remove-tags",function(){l("remove")})},initBulkTransfer:function(){var t=e("#bulk-transfer-modal");if(!t.length)return;var u=e("meta[name=csrf-token]").attr("content"),a=null;function o(){return e("#transfer-member-data").val()?e("#transfer-member-data").val().split(","):[]}function c(){var s=e("#transfer-platoon").val();e("#bulk-transfer-submit").prop("disabled",!s)}function l(){if(a){r();return}var s=t.data("platoons-url");e.ajax({url:s,method:"GET",success:function(i){a=i.platoons,r()},error:function(){toastr.error("Failed to load platoons")}})}function r(){var s=e("#transfer-platoon");s.find("option:not(:first)").remove(),a.forEach(function(i){s.append(e("<option>",{value:i.id,text:i.name}))})}function m(s){var i=e("#transfer-squad");if(i.find("option:not(:first)").remove(),!s){i.prop("disabled",!0);return}var b=a.find(function(g){return g.id==s});b&&b.squads.length>0?(b.squads.forEach(function(g){i.append(e("<option>",{value:g.id,text:g.name}))}),i.prop("disabled",!1)):i.prop("disabled",!0)}t.on("show.bs.modal",function(){var s=t.data("parttimers")==="true";if(s){e("#bulk-transfer-parttimer-warning").show(),e("#bulk-transfer-form-content").hide(),e("#bulk-transfer-submit").hide();return}e("#bulk-transfer-parttimer-warning").hide(),e("#bulk-transfer-form-content").show(),e("#bulk-transfer-submit").show();var i=o().length;e("#bulk-transfer-member-count").text(i+" member"+(i!==1?"s":"")+" selected"),e("#transfer-platoon").val(""),e("#transfer-squad").val("").prop("disabled",!0),c(),l()}),e(document).on("change","#transfer-platoon",function(){var s=e(this).val();m(s),c()}),e(document).on("click","#bulk-transfer-submit",function(){var s=o(),i=e("#transfer-platoon").val(),b=e("#transfer-squad").val(),g=t.data("store-url");if(!i){toastr.warning("Please select a platoon");return}var h=e(this);h.prop("disabled",!0).html('<span class="themed-spinner spinner-sm"></span> Transferring...'),e.ajax({url:g,method:"POST",data:{member_ids:s,platoon_id:i,squad_id:b||null,_token:u},success:function(p){toastr.success(p.message),t.modal("hide"),location.reload()},error:function(){toastr.error("Failed to transfer members")},complete:function(){h.prop("disabled",!1).html('<i class="fa fa-exchange-alt"></i> Transfer'),c()}})})},initBulkReminder:function(){var t=e("#bulk-reminder-btn");if(t.length){var u=e("meta[name=csrf-token]").attr("content");t.on("click",function(){var a=e("#pm-member-data").val();if(!a){toastr.warning("No members selected");return}var o=a.split(","),c=t.data("url");t.prop("disabled",!0).html('<span class="themed-spinner spinner-sm"></span>'),e.ajax({url:c,method:"POST",data:{_token:u,member_ids:o},success:function(l){var r=l.count+" member"+(l.count!==1?"s":"")+" marked as reminded";l.skipped>0&&(r+=" ("+l.skipped+" skipped - already reminded today)"),toastr.success(r),l.updatedIds.forEach(function(m){var s=e('.activity-reminder-toggle[data-member-id="'+m+'"]');s.length&&(s.removeClass("btn-success").addClass("btn-default"),s.html('<i class="fa fa-bell"></i> <span class="reminded-date">'+l.date+"</span>"),s.attr("title","Reminded just now"),s.prop("disabled",!0))}),e(".bulk-action-close").click()},error:function(l){var r=l.responseJSON?.message||"Failed to set reminders";toastr.error(r)},complete:function(){t.prop("disabled",!1).html('<i class="fa fa-bell text-accent"></i> <span class="hidden-xs hidden-sm">Reminder</span>')}})})}}},x.setup()}T();
