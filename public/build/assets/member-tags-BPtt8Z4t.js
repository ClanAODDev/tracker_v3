const o={$container:null,$dropdown:null,$createModal:null,$createForm:null,urls:{},csrfToken:null,setup(){this.$container=$("#member-tags-display"),!(!this.$container.length||!this.$container.data("tags-url"))&&(this.$dropdown=$("#available-tags-dropdown"),this.$createModal=$("#create-tag-modal"),this.$createForm=$("#create-tag-form"),this.urls={tags:this.$container.data("tags-url"),add:this.$container.data("add-url"),remove:this.$container.data("remove-url"),create:this.$container.data("create-url")},this.csrfToken=$("meta[name=csrf-token]").attr("content"),this.bindEvents())},bindEvents(){$(document).on("click",".remove-tag",t=>{t.preventDefault(),t.stopPropagation(),this.removeTag($(t.currentTarget).closest(".member-tag"))}),this.$dropdown.parent().on("show.bs.dropdown",()=>this.loadAvailableTags()).on("shown.bs.dropdown",()=>$("#tag-search-input").focus()),$(document).on("click",".tag-option",t=>{t.preventDefault(),this.addTag($(t.currentTarget))}),$(document).on("input","#tag-search-input",t=>{t.stopPropagation();const a=$(t.currentTarget).val().toLowerCase();$(".tag-option").each(function(){const e=$(this).data("tag-name").toLowerCase();$(this).toggle(e.includes(a))})}),$(document).on("keydown","#tag-search-input",t=>t.stopPropagation()),this.$createModal.on("shown.bs.modal",()=>$("#new-tag-name").focus()),this.$createForm.on("submit",t=>{t.preventDefault(),this.createTag()})},createTagBadge(t,a=!0){const e=a?' <span class="remove-tag" style="margin-left: 4px; cursor: pointer; opacity: 0;">&times;</span>':"";return $(`<span class="badge member-tag tag-visibility-${t.visibility}" data-tag-id="${t.id}" data-visibility="${t.visibility}">${t.name}${e}</span> `)},removeTag(t){const a=t.data("tag-id");t.css("opacity","0.5"),$.ajax({url:this.urls.remove,method:"POST",data:{tag_id:a,_token:this.csrfToken},success:()=>t.fadeOut(200,function(){$(this).remove()}),error:()=>{t.css("opacity","1"),toastr.error("Failed to remove tag")}})},loadAvailableTags(){this.$dropdown.html('<li class="dropdown-header">Loading...</li>'),$.ajax({url:this.urls.tags,method:"GET",success:t=>{const a=t.available.filter(i=>!t.assigned.includes(i.id)),e=this.$createModal.length>0;let s=`
                    <li class="dropdown-header" style="padding: 5px 10px;">
                        <input type="text" id="tag-search-input" class="form-control input-sm" placeholder="Search tags..." style="width: 100%;">
                    </li>`;if(a.length===0)s+='<li><a href="#" class="text-muted" style="pointer-events: none;">No tags available</a></li>';else{const i=a.map(r=>`
                        <div class="tag-option" data-tag-id="${r.id}" data-tag-name="${r.name}" data-tag-visibility="${r.visibility}">
                            <a href="#"><span class="badge tag-visibility-${r.visibility}">${r.name}</span></a>
                        </div>`).join("");s+=`<li class="tag-options-wrapper"><div class="tag-options-scroll">${i}</div></li>`}e&&(s+=`
                        <li role="separator" class="divider"></li>
                        <li><a href="#" data-toggle="modal" data-target="#create-tag-modal"><i class="fa fa-plus"></i> Create new tag</a></li>`),this.$dropdown.html(s)},error:()=>{this.$dropdown.html('<li><a href="#" class="text-danger" style="pointer-events: none;">Failed to load</a></li>')}})},addTag(t){const a={id:t.data("tag-id"),name:t.data("tag-name"),visibility:t.data("tag-visibility")};t.css("opacity","0.5"),$.ajax({url:this.urls.add,method:"POST",data:{tag_id:a.id,_token:this.csrfToken},success:()=>{this.$dropdown.parent().before(this.createTagBadge(a)),t.remove()},error:()=>{t.css("opacity","1"),toastr.error("Failed to add tag")}})},createTag(){const t=$("#new-tag-name").val().trim(),a=$("#new-tag-visibility").val();if(!t){toastr.warning("Please enter a tag name");return}const e=this.$createForm.find('button[type="submit"]');e.prop("disabled",!0),$.ajax({url:this.urls.create,method:"POST",data:{name:t,visibility:a,_token:this.csrfToken},success:s=>{this.$dropdown.parent().before(this.createTagBadge(s.tag)),this.$createModal.modal("hide"),this.$createForm[0].reset(),toastr.success("Tag created and assigned")},error:s=>{const i=s.responseJSON?.error||"Failed to create tag";toastr.error(i)},complete:()=>e.prop("disabled",!1)})}};o.setup();
