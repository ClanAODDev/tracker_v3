var v=v||{};function w(){const e=window.jQuery;if(!e||typeof e.fn.DataTable!="function"||typeof e.fn.bootcomplete!="function"||typeof e.fn.select2!="function"){setTimeout(w,50);return}if(document.readyState!=="complete"&&document.readyState!=="interactive"){setTimeout(w,50);return}const f=e("meta[name=csrf-token]").attr("content");v={dataTable:null,setup(){this.handleMembers(),this.handleSquadMembers(),this.handleVoiceActivityChart(),this.initAutocomplete(),this.initTagFilter(),this.initBulkTags(),this.initBulkTransfer(),this.initSquadAssignments(),this.initBulkReminder()},handleVoiceActivityChart(){const n=document.getElementById("voice-activity-chart");if(!n||typeof Chart>"u")return;const t=JSON.parse(n.dataset.values||"[]"),r=JSON.parse(n.dataset.labels||"[]"),c=JSON.parse(n.dataset.colors||"[]");if(!t||!r||t.length===0)return;const l=getComputedStyle(document.documentElement),a=l.getPropertyValue("--color-text-light").trim()||"#949ba2",u=l.getPropertyValue("--color-bg-panel").trim()||"#1a1d21",s=t.reduce((i,b)=>i+b,0);new Chart(n,{type:"doughnut",data:{labels:r,datasets:[{data:t,backgroundColor:c,borderColor:u,borderWidth:1,hoverBorderColor:u,hoverOffset:2}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"60%",plugins:{legend:{display:!0,position:"bottom",labels:{color:a,usePointStyle:!0,pointStyle:"circle",font:{size:11},padding:12,boxWidth:8,boxHeight:8}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.7)",titleFont:{size:12},bodyFont:{size:11},padding:10,cornerRadius:6,callbacks:{label:i=>{const b=s>0?Math.round(i.parsed/s*100):0;return`${i.label}: ${i.parsed} (${b}%)`}}}}}})},handleSquadMembers(){if(!e(".manage-squads-grid").length)return;const n=e(".mod-plt .sortable"),t=()=>{const r=e(".unassigned-organizer"),l=r.find(".manage-sortable-list").find("li").length,a=r.find(".unassigned-organizer-header span");l===0?(r.removeClass("unassigned-organizer").addClass("all-assigned-organizer"),a.html('<i class="fa fa-check-circle text-success"></i> All members assigned to a squad')):(r.removeClass("all-assigned-organizer").addClass("unassigned-organizer"),a.html(`<i class="fa fa-exclamation-triangle text-warning"></i> ${l} ${l===1?"member":"members"} not assigned to a squad`))};n.sortable({connectWith:".mod-plt .sortable",placeholder:"ui-sortable-placeholder",forcePlaceholderSize:!0,revert:150,tolerance:"pointer",over:function(r,c){e(this).closest(".manage-squad-card, .unassign-drop-zone").addClass("drag-hover")},out:function(r,c){e(this).closest(".manage-squad-card, .unassign-drop-zone").removeClass("drag-hover")},receive:function(r,c){const l=e(this),a=e(c.sender),u=e(c.item).attr("data-member-id"),s=l.attr("data-squad-id"),i=a.find("li").length,b=l.find("li").length,m=e(c.item);a.closest(".manage-squad-card").find(".count").text(i),l.closest(".manage-squad-card").find(".count").text(b),t(),s==="0"&&m.fadeOut(200,function(){e(this).remove()}),e.ajax({type:"POST",url:`${window.Laravel.appPath}/members/assign-squad`,data:{member_id:u,squad_id:s,_token:f},dataType:"json",success:()=>{s==="0"?toastr.success("Member unassigned from platoon"):toastr.success("Member reassigned!")},error:()=>{toastr.error("Failed to reassign member")}})},stop:function(r,c){e(".manage-squad-card, .unassign-drop-zone").removeClass("drag-hover")}})},initSquadAssignments(){let n=!1;if(e(".organize-squads-btn").on("click",t=>{n=!n;const r=e(t.currentTarget);n?(r.html('<i class="fa fa-check"></i> Done'),r.removeClass("btn-accent").addClass("btn-success"),e(".unassigned-organizer-members").slideDown(200),e(".squad-assignments-section").addClass("organize-mode"),this.enableSquadDragDrop()):(r.html('<i class="fa fa-arrows-alt"></i> Organize'),r.removeClass("btn-success").addClass("btn-accent"),e(".unassigned-organizer-members").slideUp(200),e(".squad-assignments-section").removeClass("organize-mode"))}),e(".squad-drop-target").on("click",t=>{e(".squad-assignments-section").hasClass("organize-mode")&&t.preventDefault()}),new URLSearchParams(window.location.search).get("organize")==="1"){e(".organize-squads-btn").trigger("click");const t=e(".squad-assignments-section");t.length&&e("html, body").animate({scrollTop:t.offset().top-20},400)}},enableSquadDragDrop(){e(".unassigned-squad-member").data("ui-draggable")||(e(".unassigned-squad-member").draggable({revert:!0,revertDuration:200,zIndex:1e3,cursor:"grabbing",helper:"clone",appendTo:"body"}),e(".squad-drop-target").droppable({hoverClass:"squad-drop-target--active",drop:function(n,t){const r=e(this),c=t.draggable.attr("data-member-id"),l=r.attr("data-squad-id"),a=e(t.draggable);e.ajax({type:"POST",url:`${window.Laravel.appPath}/members/assign-squad`,data:{member_id:c,squad_id:l,_token:f},dataType:"json",success:()=>{toastr.success("Member assigned to squad!"),a.fadeOut(200,function(){e(this).remove(),e(".unassigned-squad-member").length<1&&(e(".unassigned-organizer").slideUp(),e(".squad-assignments-section").removeClass("organize-mode"))});const u=r.find(".squad-stat-badge .fa-users").parent(),s=parseInt(u.text().trim())||0;u.html(`<i class="fa fa-users"></i> ${s+1}`)},error:()=>{toastr.error("Failed to assign member to squad")}})}}))},initAutocomplete(){e("#leader").bootcomplete({url:`${window.Laravel.appPath}/search-member/`,minLength:3,idField:!0,method:"POST",dataParams:{_token:f}})},handleMembers(){if(!e(".members-table").length)return;const n=e("table.members-table"),t={};n.find("thead th[data-col]").each(function(o){t[e(this).data("col")]=o}),this.dataTable=n.DataTable({initComplete:(o,d)=>{setTimeout(()=>{e(".ld-loading").removeClass("ld-loading"),this.dataTable.columns.adjust()},2e3)},autoWidth:!1,info:!1,paging:!1,stateSave:!0,order:[[t.member,"asc"]],language:{lengthMenu:""},columnDefs:[{targets:t.checkbox,visible:!1,orderable:!1,searchable:!1},{targets:t.tags,visible:!1},{targets:t["inactivity-reminder"],visible:!1},{targets:"no-sort",orderable:!1},{targets:"no-search",searchable:!1},{targets:"col-hidden",visible:!1},{targets:t.rank,orderData:t["rank-id"]},{targets:t["discord-activity"],orderData:t["discord-activity-date"]},{targets:t["inactivity-reminder"],orderData:t["reminder-date"]}],stateSaveParams:(o,d)=>{d.columns[t.checkbox].visible=!1,d.columns[t.member].visible=!0,d.order&&d.order[0]&&d.order[0][0]===t.checkbox&&(d.order=[[t.member,"asc"]])},stateLoadParams:(o,d)=>{d.columns[t.checkbox].visible=!1,d.columns[t.member].visible=!0,d.order&&d.order[0]&&d.order[0][0]===t.checkbox&&(d.order=[[t.member,"asc"]])}}),this.cols=t;let r;e(window).on("resize",()=>{clearTimeout(r),r=setTimeout(()=>{this.dataTable.columns.adjust().draw()},100)});const c=o=>t[o],l=(o,d)=>{const g=e(o),h=g.find("i.fa");d.visible()?(g.addClass("active"),h.removeClass("fa-square-o").addClass("fa-check")):(g.removeClass("active"),h.removeClass("fa-check").addClass("fa-square-o"))};e("a.toggle-vis").each(function(){const o=e(this).data("column"),d=c(o);if(d!==void 0){const g=v.dataTable.column(d);l(this,g)}}),e("a.toggle-vis").on("click",function(o){o.preventDefault(),o.stopPropagation();const d=e(this).data("column"),g=c(d);if(g!==void 0){const h=v.dataTable.column(g);h.visible(!h.visible()),l(this,h)}});const a=e(".column-dropdown"),u=a.find(".dropdown-toggle"),s=a.find(".column-toggle-menu");u.on("click",o=>{o.preventDefault(),o.stopPropagation(),a.hasClass("show")?(a.removeClass("show"),s.removeClass("show")):(a.addClass("show"),s.addClass("show"),s.scrollTop(0))}),e(document).on("click",o=>{e(o.target).closest(".column-dropdown").length||(a.removeClass("show"),s.removeClass("show"))});const i=e(".dataTables_filter input").removeClass("input-sm");i.attr({placeholder:"Search Players",class:"form-control"}),e("#playerFilter").append(i),e(".dataTables_filter label").remove();const b=e("#tag-filter");if(b.length){const o=e('<div class="tag-filter-wrapper"></div>');o.append(b),e("#playerFilter").append(o)}let m=null,p=!1;window.Laravel&&window.Laravel.canUseBulkMode&&(m=e('<button type="button" class="btn btn-default bulk-mode-toggle">Bulk Mode</button>'),e("#playerFilter").append(m),m.on("click",()=>{$()})),e(".no-sort").removeClass("sorting");const $=()=>{if(!m)return;p=!p,this.dataTable.column(t.checkbox).visible(p),p?(m.addClass("active btn-accent").removeClass("btn-default"),m.html('<i class="fa fa-check-circle"></i> Exit Bulk Mode'),e(".members-table").addClass("bulk-mode")):(m.removeClass("active btn-accent").addClass("btn-default"),m.html("Bulk Mode"),e(".members-table").removeClass("bulk-mode"),e(".member-checkbox, #select-all-members").prop("checked",!1),k())},k=()=>{const o=[];e(".member-checkbox:checked").each(function(){o.push(e(this).val())});const d=e('.member-checkbox:checked[data-parttimer="1"]').length>0,g=e("#bulk-transfer-btn");d?(g.prop("disabled",!0).addClass("disabled"),g.attr("title","Cannot transfer: selection includes part-time members")):(g.prop("disabled",!1).removeClass("disabled"),g.removeAttr("title")),o.length>=1?(e("#selected-data").css("display","block"),e("#selected-data .status-text").text(`${o.length} member${o.length===1?"":"s"} selected`),e("#pm-member-data").val(o),e("#tag-member-data").val(o),e("#transfer-member-data").val(o)):(e("#selected-data").hide(),e("#pm-member-data").val(""),e("#tag-member-data").val(""),e("#transfer-member-data").val(""));const h=e(".member-checkbox").length,C=e(".member-checkbox:checked").length;e("#select-all-members").prop("checked",C>0&&C===h),e("#select-all-members").prop("indeterminate",C>0&&C<h)};e(document).on("click",".bulk-action-close",()=>{e(".member-checkbox, #select-all-members").prop("checked",!1),k()}),e(document).on("change",".member-checkbox",()=>{k()}),e(document).on("change","#select-all-members",function(){const o=e(this).prop("checked");e(".member-checkbox").prop("checked",o),k()});let x=!1,T=!0;e(document).on("mousedown",".members-table.bulk-mode tbody tr",function(o){if(e(o.target).closest("a, button, input, .btn").length||o.which!==1)return;x=!0,e(this).index();const d=e(this).find(".member-checkbox");T=!d.prop("checked"),d.prop("checked",T),k(),o.preventDefault()}),e(document).on("mouseenter",".members-table.bulk-mode tbody tr",function(){if(!x)return;e(this).find(".member-checkbox").prop("checked",T),k()}),e(document).on("mouseup",()=>{x=!1}),e("#is_tba").click(()=>{q()}),q();const q=()=>{e("#is_tba").is(":checked")?e("#leader_id, #leader").prop("disabled",!0).val(""):e("#leader_id, #leader").prop("disabled",!1)}},initTagFilter(){const n=e("#tag-filter");if(!n.length||!this.dataTable||!this.cols)return;const t=this.cols["tag-ids"];n.select2({placeholder:"Filter by tag",allowClear:!0}).on("change",()=>{this.dataTable.draw()}),e.fn.dataTable.ext.search.push((r,c,l)=>{const a=n.val();if(!a||a.length===0)return!0;const u=c[t]?c[t].split(","):[];return a.some(s=>u.includes(s))})},initBulkTags(){const n=e("#bulk-tags-modal");if(!n.length)return;const t=()=>e("#tag-member-data").val()?e("#tag-member-data").val().split(","):[],r=()=>{const a=[];return e(".bulk-tag-checkbox:checked").each(function(){a.push(e(this).val())}),a},c=()=>{const a=r().length>0;e("#bulk-assign-tags, #bulk-remove-tags").prop("disabled",!a)};n.on("show.bs.modal",()=>{const a=t().length;e("#bulk-tags-member-count").text(`${a} member${a!==1?"s":""} selected`),e(".bulk-tag-checkbox").prop("checked",!1).trigger("change")}),e(document).on("change",".bulk-tag-checkbox",function(){const a=e(this).siblings(".bulk-tag-badge");this.checked?a.addClass("selected"):a.removeClass("selected"),c()});const l=a=>{const u=t(),s=r(),i=n.data("store-url");if(s.length===0){toastr.warning("Please select at least one tag");return}e("#bulk-assign-tags, #bulk-remove-tags").prop("disabled",!0),e.ajax({url:i,method:"POST",data:{member_ids:u,tags:s,action:a,_token:f},success:()=>{const m=a==="assign"?"Tags assigned to ":"Tags removed from ";toastr.success(`${m}${u.length} members`),n.modal("hide"),location.reload()},error:()=>{toastr.error(`Failed to ${a} tags`)},complete:()=>{c()}})};e(document).on("click","#bulk-assign-tags",()=>{l("assign")}),e(document).on("click","#bulk-remove-tags",()=>{l("remove")})},initBulkTransfer(){const n=e("#bulk-transfer-modal");if(!n.length)return;let t=null;const r=()=>e("#transfer-member-data").val()?e("#transfer-member-data").val().split(","):[],c=()=>{const s=e("#transfer-platoon").val();e("#bulk-transfer-submit").prop("disabled",!s)},l=()=>{const s=e("#transfer-platoon");s.find("option:not(:first)").remove(),t.forEach(i=>{s.append(e("<option>",{value:i.id,text:i.name}))})},a=()=>{if(t){l();return}const s=n.data("platoons-url");e.ajax({url:s,method:"GET",success:i=>{t=i.platoons,l()},error:()=>{toastr.error("Failed to load platoons")}})},u=s=>{const i=e("#transfer-squad");if(i.find("option:not(:first)").remove(),!s){i.prop("disabled",!0);return}const b=t.find(m=>m.id==s);b&&b.squads.length>0?(b.squads.forEach(m=>{i.append(e("<option>",{value:m.id,text:m.name}))}),i.prop("disabled",!1)):i.prop("disabled",!0)};n.on("show.bs.modal",()=>{if(n.data("parttimers")==="true"){e("#bulk-transfer-parttimer-warning").show(),e("#bulk-transfer-form-content").hide(),e("#bulk-transfer-submit").hide();return}e("#bulk-transfer-parttimer-warning").hide(),e("#bulk-transfer-form-content").show(),e("#bulk-transfer-submit").show();const i=r().length;e("#bulk-transfer-member-count").text(`${i} member${i!==1?"s":""} selected`),e("#transfer-platoon").val(""),e("#transfer-squad").val("").prop("disabled",!0),c(),a()}),e(document).on("change","#transfer-platoon",function(){const s=e(this).val();u(s),c()}),e(document).on("click","#bulk-transfer-submit",function(){const s=r(),i=e("#transfer-platoon").val(),b=e("#transfer-squad").val(),m=n.data("store-url");if(!i){toastr.warning("Please select a platoon");return}const p=e(this);p.prop("disabled",!0).html('<span class="themed-spinner spinner-sm"></span> Transferring...'),e.ajax({url:m,method:"POST",data:{member_ids:s,platoon_id:i,squad_id:b||null,_token:f},success:$=>{toastr.success($.message),n.modal("hide"),location.reload()},error:()=>{toastr.error("Failed to transfer members")},complete:()=>{p.prop("disabled",!1).html('<i class="fa fa-exchange-alt"></i> Transfer'),c()}})})},initBulkReminder(){const n=e("#bulk-reminder-btn");n.length&&n.on("click",()=>{const t=e("#pm-member-data").val();if(!t){toastr.warning("No members selected");return}const r=t.split(","),c=n.data("url");n.prop("disabled",!0).html('<span class="themed-spinner spinner-sm"></span>'),e.ajax({url:c,method:"POST",data:{_token:f,member_ids:r},success:l=>{let a=`${l.count} member${l.count!==1?"s":""} marked as reminded`;l.skipped>0&&(a+=` (${l.skipped} skipped - already reminded today)`),toastr.success(a),l.updatedIds.forEach(u=>{const s=e(`.activity-reminder-toggle[data-member-id="${u}"]`);s.length&&(s.removeClass("btn-success").addClass("btn-default"),s.html(`<i class="fa fa-bell"></i> <span class="reminded-date">${l.date}</span>`),s.attr("title","Reminded just now"),s.prop("disabled",!0))}),e(".bulk-action-close").click()},error:l=>{const a=l.responseJSON?.message||"Failed to set reminders";toastr.error(a)},complete:()=>{n.prop("disabled",!1).html('<i class="fa fa-bell text-accent"></i> <span class="hidden-xs hidden-sm">Reminder</span>')}})})}},v.setup()}w();
