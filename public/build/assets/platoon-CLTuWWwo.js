var q=q||{};(function(e){q={dataTable:null,setup:function(){this.handleMembers(),this.handleSquadMembers(),this.handleForumActivityChart(),this.handleVoiceActivityChart(),this.initAutocomplete(),this.initTagFilter(),this.initBulkTags(),this.initBulkTransfer(),this.initSquadAssignments()},handleForumActivityChart:function(){var t=e(".forum-activity-chart");t.length&&new Chart(t,{type:"doughnut",data:{datasets:[{data:t.data("values"),backgroundColor:t.data("colors"),borderWidth:0}],labels:t.data("labels")},options:{rotation:1*Math.PI,circumference:1*Math.PI,legend:{position:"bottom",labels:{boxWidth:5,fontColor:"#949ba2"},label:{fullWidth:!1}}}})},handleVoiceActivityChart:function(){var t=e(".voice-activity-chart");t.length&&new Chart(t,{type:"doughnut",data:{datasets:[{data:t.data("values"),backgroundColor:t.data("colors"),borderWidth:0}],labels:t.data("labels")},options:{rotation:1*Math.PI,circumference:1*Math.PI,legend:{position:"bottom",labels:{boxWidth:5,fontColor:"#949ba2"},label:{fullWidth:!1}}}})},handleSquadMembers:function(){if(!e(".manage-squads-grid").length)return;var t=e(".mod-plt .sortable");function i(){var a=e(".unassigned-organizer"),r=a.find(".manage-sortable-list"),s=r.find("li").length,l=a.find(".unassigned-organizer-header span");s===0?(a.removeClass("unassigned-organizer").addClass("all-assigned-organizer"),l.html('<i class="fa fa-check-circle text-success"></i> All members assigned to a squad')):(a.removeClass("all-assigned-organizer").addClass("unassigned-organizer"),l.html('<i class="fa fa-exclamation-triangle text-warning"></i> '+s+" "+(s===1?"member":"members")+" not assigned to a squad"))}t.sortable({connectWith:".mod-plt .sortable",placeholder:"ui-sortable-placeholder",forcePlaceholderSize:!0,revert:150,tolerance:"pointer",over:function(a,r){e(this).closest(".manage-squad-card, .unassign-drop-zone").addClass("drag-hover")},out:function(a,r){e(this).closest(".manage-squad-card, .unassign-drop-zone").removeClass("drag-hover")},receive:function(a,r){var s=e(this),l=e(r.sender),n=e(r.item).attr("data-member-id"),m=s.attr("data-squad-id"),d=l.find("li").length,c=s.find("li").length;l.closest(".manage-squad-card").find(".count").text(d),s.closest(".manage-squad-card").find(".count").text(c),i(),m==="0"&&e(r.item).fadeOut(200,function(){e(this).remove()}),e.ajax({type:"POST",url:window.Laravel.appPath+"/members/assign-squad",data:{member_id:n,squad_id:m,_token:e("meta[name=csrf-token]").attr("content")},dataType:"json",success:function(){m==="0"?toastr.success("Member unassigned from platoon"):toastr.success("Member reassigned!")},error:function(){toastr.error("Failed to reassign member")}})},stop:function(a,r){e(".manage-squad-card, .unassign-drop-zone").removeClass("drag-hover")}})},initSquadAssignments:function(){var t=this,i=!1;if(e(".organize-squads-btn").on("click",function(){i=!i;var r=e(this);i?(r.html('<i class="fa fa-check"></i> Done'),r.removeClass("btn-accent").addClass("btn-success"),e(".unassigned-organizer-members").slideDown(200),e(".squad-assignments-section").addClass("organize-mode"),t.enableSquadDragDrop()):(r.html('<i class="fa fa-arrows-alt"></i> Organize'),r.removeClass("btn-success").addClass("btn-accent"),e(".unassigned-organizer-members").slideUp(200),e(".squad-assignments-section").removeClass("organize-mode"))}),e(".squad-drop-target").on("click",function(r){e(".squad-assignments-section").hasClass("organize-mode")&&r.preventDefault()}),new URLSearchParams(window.location.search).get("organize")==="1"){e(".organize-squads-btn").trigger("click");var a=e(".squad-assignments-section");a.length&&e("html, body").animate({scrollTop:a.offset().top-20},400)}},enableSquadDragDrop:function(){var t=this;e(".unassigned-squad-member").data("ui-draggable")||(e(".unassigned-squad-member").draggable({revert:!0,revertDuration:200,zIndex:1e3,cursor:"grabbing",helper:"clone",appendTo:"body"}),e(".squad-drop-target").droppable({hoverClass:"squad-drop-target--active",drop:function(i,a){t.handleSquadDrop(e(this),a.draggable)}}),this.initTouchDragDrop())},handleSquadDrop:function(t,i){var a=i.attr("data-member-id"),r=t.attr("data-squad-id");e.ajax({type:"POST",url:window.Laravel.appPath+"/members/assign-squad",data:{member_id:a,squad_id:r,_token:e("meta[name=csrf-token]").attr("content")},dataType:"json",success:function(){toastr.success("Member assigned to squad!"),i.fadeOut(200,function(){e(this).remove(),e(".unassigned-squad-member").length<1&&(e(".unassigned-organizer").slideUp(),e(".squad-assignments-section").removeClass("organize-mode"))});var s=t.find(".squad-stat-badge .fa-users").parent(),l=parseInt(s.text().trim())||0;s.html('<i class="fa fa-users"></i> '+(l+1))},error:function(){toastr.error("Failed to assign member to squad")}})},initTouchDragDrop:function(){var t=this,i=null,a=null;e(".unassigned-squad-member").each(function(){var r=this;r.addEventListener("touchstart",function(s){if(s.touches.length===1){i=e(this);var l=s.touches[0];l.clientX,l.clientY,a=i.clone().addClass("touch-drag-clone").css({position:"fixed",zIndex:1e4,pointerEvents:"none",opacity:.9,boxShadow:"0 4px 12px rgba(0,0,0,0.4)",left:l.clientX-50,top:l.clientY-20}).appendTo("body"),i.addClass("touch-dragging")}},{passive:!0}),r.addEventListener("touchmove",function(s){if(a){s.preventDefault();var l=s.touches[0];a.css({left:l.clientX-50,top:l.clientY-20}),e(".squad-drop-target").removeClass("squad-drop-target--active");var n=document.elementFromPoint(l.clientX,l.clientY),m=e(n).closest(".squad-drop-target");m.length&&m.addClass("squad-drop-target--active")}},{passive:!1}),r.addEventListener("touchend",function(s){if(!(!a||!i)){var l=s.changedTouches[0],n=document.elementFromPoint(l.clientX,l.clientY),m=e(n).closest(".squad-drop-target");m.length&&t.handleSquadDrop(m,i),a.remove(),a=null,i.removeClass("touch-dragging"),i=null,e(".squad-drop-target").removeClass("squad-drop-target--active")}},{passive:!0})})},initAutocomplete:function(){e("#leader").bootcomplete({url:window.Laravel.appPath+"/search-member/",minLength:3,idField:!0,method:"POST",dataParams:{_token:e("meta[name=csrf-token]").attr("content")}})},handleMembers:function(){if(!e(".members-table").length)return;var t=this,i=e("table.members-table"),a={};i.find("thead th[data-col]").each(function(o){a[e(this).data("col")]=o}),t.dataTable=i.DataTable({initComplete:function(o,u){setTimeout(function(){e(".ld-loading").removeClass("ld-loading"),t.dataTable.columns.adjust()},2e3)},autoWidth:!1,info:!1,paging:!1,stateSave:!0,order:[[a.member,"asc"]],language:{lengthMenu:""},columnDefs:[{targets:a.checkbox,visible:!1,orderable:!1,searchable:!1},{targets:a.tags,visible:!1},{targets:"no-sort",orderable:!1},{targets:"no-search",searchable:!1},{targets:"col-hidden",visible:!1},{targets:a.rank,orderData:a["rank-id"]},{targets:a["discord-activity"],orderData:a["discord-activity-date"]}],stateSaveParams:function(o,u){u.columns[a.checkbox].visible=!1,u.columns[a.member].visible=!0,u.order&&u.order[0]&&u.order[0][0]===a.checkbox&&(u.order=[[a.member,"asc"]])},stateLoadParams:function(o,u){u.columns[a.checkbox].visible=!1,u.columns[a.member].visible=!0,u.order&&u.order[0]&&u.order[0][0]===a.checkbox&&(u.order=[[a.member,"asc"]])}}),t.cols=a;var r;e(window).on("resize",function(){clearTimeout(r),r=setTimeout(function(){t.dataTable.columns.adjust().draw()},100)});function s(o){return a[o]}function l(o,u){u.visible()?e(o).addClass("active"):e(o).removeClass("active")}e("a.toggle-vis").each(function(){var o=e(this).data("column"),u=s(o);if(u!==void 0){var h=t.dataTable.column(u);l(this,h)}}),e("a.toggle-vis").on("click",function(o){o.preventDefault();var u=e(this).data("column"),h=s(u);if(h!==void 0){var v=t.dataTable.column(h);v.visible(!v.visible()),l(this,v)}});var n=e(".dataTables_filter input").removeClass("input-sm");n.attr({placeholder:"Search Players",class:"form-control"}),e("#playerFilter").append(n),e(".dataTables_filter label").remove();var m=e("#tag-filter");if(m.length){var d=e('<div class="tag-filter-wrapper"></div>');d.append(m),e("#playerFilter").append(d)}var c=e('<button type="button" class="btn btn-default bulk-mode-toggle"><i class="fa fa-check-square-o"></i> Bulk Mode</button>');e("#playerFilter").append(c),e(".no-sort").removeClass("sorting");var f=!1;function b(){f=!f;var o=t.dataTable.column(a.checkbox);o.visible(f),f?(c.addClass("active btn-accent").removeClass("btn-default"),c.html('<i class="fa fa-check-circle"></i> Exit Bulk Mode'),e(".members-table").addClass("bulk-mode")):(c.removeClass("active btn-accent").addClass("btn-default"),c.html('<i class="fa fa-check-square-o"></i> Bulk Mode'),e(".members-table").removeClass("bulk-mode"),e(".member-checkbox, #select-all-members").prop("checked",!1),g())}c.on("click",function(){b()});function g(){var o=[];e(".member-checkbox:checked").each(function(){o.push(e(this).val())});var u=e('.member-checkbox:checked[data-parttimer="1"]').length>0,h=e("#bulk-transfer-btn");u?(h.prop("disabled",!0).addClass("disabled"),h.attr("title","Cannot transfer: selection includes part-time members")):(h.prop("disabled",!1).removeClass("disabled"),h.removeAttr("title")),o.length>=2?(e("#selected-data").css("display","block"),e("#selected-data .status-text").text(o.length+" members selected"),e("#pm-member-data").val(o),e("#tag-member-data").val(o),e("#transfer-member-data").val(o)):(e("#selected-data").hide(),e("#pm-member-data").val(""),e("#tag-member-data").val(""),e("#transfer-member-data").val(""));var v=e(".member-checkbox").length,k=e(".member-checkbox:checked").length;e("#select-all-members").prop("checked",k>0&&k===v),e("#select-all-members").prop("indeterminate",k>0&&k<v)}e(document).on("click",".bulk-action-close",function(){e(".member-checkbox, #select-all-members").prop("checked",!1),g()}),e(document).on("change",".member-checkbox",function(){g()}),e(document).on("change","#select-all-members",function(){var o=e(this).prop("checked");e(".member-checkbox").prop("checked",o),g()});var p=!1,C=!0;e(document).on("mousedown",".members-table.bulk-mode tbody tr",function(o){if(!e(o.target).closest("a, button, input, .btn").length&&o.which===1){p=!0,e(this).index();var u=e(this).find(".member-checkbox");C=!u.prop("checked"),u.prop("checked",C),g(),o.preventDefault()}}),e(document).on("mouseenter",".members-table.bulk-mode tbody tr",function(){if(p){var o=e(this).find(".member-checkbox");o.prop("checked",C),g()}}),e(document).on("mouseup",function(){p=!1}),e("#is_tba").click(function(){x()}),x();function x(){e("#is_tba").is(":checked")?e("#leader_id, #leader").prop("disabled",!0).val(""):e("#leader_id, #leader").prop("disabled",!1)}},initTagFilter:function(){var t=this,i=e("#tag-filter");if(!(!i.length||!t.dataTable||!t.cols)){var a=t.cols["tag-ids"];i.select2({placeholder:"Filter by tag",allowClear:!0}).on("change",function(){t.dataTable.draw()}),e.fn.dataTable.ext.search.push(function(r,s,l){var n=i.val();if(!n||n.length===0)return!0;for(var m=s[a]?s[a].split(","):[],d=0;d<n.length;d++)if(m.indexOf(n[d])!==-1)return!0;return!1})}},initBulkTags:function(){var t=e("#bulk-tags-modal");if(!t.length)return;var i=e("meta[name=csrf-token]").attr("content");function a(){return e("#tag-member-data").val()?e("#tag-member-data").val().split(","):[]}function r(){var n=[];return e(".bulk-tag-checkbox:checked").each(function(){n.push(e(this).val())}),n}function s(){var n=r().length>0;e("#bulk-assign-tags, #bulk-remove-tags").prop("disabled",!n)}t.on("show.bs.modal",function(){var n=a().length;e("#bulk-tags-member-count").text(n+" member"+(n!==1?"s":"")+" selected"),e(".bulk-tag-checkbox").prop("checked",!1).trigger("change")}),e(document).on("change",".bulk-tag-checkbox",function(){var n=e(this).siblings(".bulk-tag-badge");this.checked?n.addClass("selected"):n.removeClass("selected"),s()});function l(n){var m=a(),d=r(),c=t.data("store-url");if(d.length===0){toastr.warning("Please select at least one tag");return}var f=e("#bulk-assign-tags, #bulk-remove-tags");f.prop("disabled",!0),e.ajax({url:c,method:"POST",data:{member_ids:m,tags:d,action:n,_token:i},success:function(){var b=n==="assign"?"Tags assigned to ":"Tags removed from ";toastr.success(b+m.length+" members"),t.modal("hide"),location.reload()},error:function(){toastr.error("Failed to "+n+" tags")},complete:function(){s()}})}e(document).on("click","#bulk-assign-tags",function(){l("assign")}),e(document).on("click","#bulk-remove-tags",function(){l("remove")})},initBulkTransfer:function(){var t=e("#bulk-transfer-modal");if(!t.length)return;var i=e("meta[name=csrf-token]").attr("content"),a=null;function r(){return e("#transfer-member-data").val()?e("#transfer-member-data").val().split(","):[]}function s(){var d=e("#transfer-platoon").val();e("#bulk-transfer-submit").prop("disabled",!d)}function l(){if(a){n();return}var d=t.data("platoons-url");e.ajax({url:d,method:"GET",success:function(c){a=c.platoons,n()},error:function(){toastr.error("Failed to load platoons")}})}function n(){var d=e("#transfer-platoon");d.find("option:not(:first)").remove(),a.forEach(function(c){d.append(e("<option>",{value:c.id,text:c.name}))})}function m(d){var c=e("#transfer-squad");if(c.find("option:not(:first)").remove(),!d){c.prop("disabled",!0);return}var f=a.find(function(b){return b.id==d});f&&f.squads.length>0?(f.squads.forEach(function(b){c.append(e("<option>",{value:b.id,text:b.name}))}),c.prop("disabled",!1)):c.prop("disabled",!0)}t.on("show.bs.modal",function(){var d=t.data("parttimers")==="true";if(d){e("#bulk-transfer-parttimer-warning").show(),e("#bulk-transfer-form-content").hide(),e("#bulk-transfer-submit").hide();return}e("#bulk-transfer-parttimer-warning").hide(),e("#bulk-transfer-form-content").show(),e("#bulk-transfer-submit").show();var c=r().length;e("#bulk-transfer-member-count").text(c+" member"+(c!==1?"s":"")+" selected"),e("#transfer-platoon").val(""),e("#transfer-squad").val("").prop("disabled",!0),s(),l()}),e(document).on("change","#transfer-platoon",function(){var d=e(this).val();m(d),s()}),e(document).on("click","#bulk-transfer-submit",function(){var d=r(),c=e("#transfer-platoon").val(),f=e("#transfer-squad").val(),b=t.data("store-url");if(!c){toastr.warning("Please select a platoon");return}var g=e(this);g.prop("disabled",!0).html('<i class="fa fa-spinner fa-spin"></i> Transferring...'),e.ajax({url:b,method:"POST",data:{member_ids:d,platoon_id:c,squad_id:f||null,_token:i},success:function(p){toastr.success(p.message),t.modal("hide"),location.reload()},error:function(){toastr.error("Failed to transfer members")},complete:function(){g.prop("disabled",!1).html('<i class="fa fa-exchange-alt"></i> Transfer'),s()}})})}}})(window.jQuery);q.setup();
